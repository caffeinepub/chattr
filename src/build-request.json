{
  "kind": "build_request",
  "title": "Reduce getChatrooms payload and continue incremental removal of authorization gates",
  "projectName": "Anon Chat Lobby",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-7",
      "text": "Update `backend/main.mo` so `public query func getChatrooms() : async [ChatroomWithLiveStatus]` no longer exceeds the Internet Computer ~3MB query reply limit (IC0504) while keeping the exact return type `[ChatroomWithLiveStatus]` and without changing any frontend code.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Failed to Load Chats... application payload size (8804262) cannot be larger than 3145728",
          "Build"
        ]
      },
      "acceptanceCriteria": [
        "Calling `getChatrooms()` does not trigger IC0504 / reject code 5 due to reply payload size.",
        "The Candid signature and Motoko return type of `getChatrooms()` remains `[ChatroomWithLiveStatus]` (no frontend changes required).",
        "The response excludes or empties large fields (e.g., `description` should remain empty, and `pinnedVideoId` should remain `null`) and avoids returning any inline base64/data URL payloads.",
        "If needed to stay under the limit, the function limits the number of returned chatrooms (e.g., return only the most recent N), and this limit is implemented entirely within `getChatrooms()` without altering stored data."
      ]
    },
    {
      "id": "REQ-8",
      "text": "Fix the chatroom thumbnail regression by ensuring `backend/main.mo` does not blank valid non-base64 `mediaUrl` values in `getChatrooms()`. Only inline `data:` / base64 payloads should be removed.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Fix thumbnail regression: ... only remove inline base64/data: payloads so room thumbnails display again",
          "Build"
        ]
      },
      "acceptanceCriteria": [
        "For normal URLs (including long URLs and blob-storage URLs that are not inline base64/data payloads), `getChatrooms()` returns the original `mediaUrl` unchanged.",
        "For inline `data:` URLs, `getChatrooms()` returns an empty `mediaUrl` string (or otherwise removes the inline payload) to avoid large responses.",
        "Room thumbnails render again in the lobby for chatrooms whose `mediaUrl` is a valid non-`data:` URL."
      ]
    },
    {
      "id": "REQ-9",
      "text": "Continue incremental anonymization by removing (or neutralizing) the runtime authorization gate in `backend/main.mo` `deleteChatroomWithPassword(...)` so anonymous callers are not blocked by `AccessControl.hasPermission(...)` / `Debug.trap(\"Unauthorized...\")`. Keep the function signature and behavior (aside from authorization) intact.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Remove all caller principal checks",
          "Ok do it in smaller pieces",
          "Build"
        ]
      },
      "acceptanceCriteria": [
        "`deleteChatroomWithPassword(chatroomId, _password)` no longer traps with an \"Unauthorized\" message based on `caller` permissions.",
        "The public method name and parameters are unchanged.",
        "No new caller/principal/authorization checks are introduced elsewhere as part of this change."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single Motoko actor; put all logic changes in `backend/main.mo`.",
    "Do not add any new authorization, caller principal checks, or AccessControl-based permission logic.",
    "Keep `getChatrooms()` return type as `[ChatroomWithLiveStatus]` to avoid frontend changes.",
    "Do not edit files under `frontend/src/components/ui` or other immutable frontend paths listed in SYSTEM_CONTEXT."
  ],
  "nonGoals": [
    "Implementing a frontend-only workaround for the IC0504 payload-size rejection.",
    "Introducing pagination endpoints or changing the frontend data model/types.",
    "Reworking or redesigning the chat UI/UX beyond what is required to restore thumbnails and load the lobby list."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}